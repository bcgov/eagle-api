#!/usr/bin/env groovy

import groovy.json.JsonOutput
import groovy.json.JsonSlurper
import java.util.regex.Pattern

/*
 * Sends a rocket chat notification
 */
def notifyRocketChat(text, url) {
    def rocketChatURL = url
    def message = text.replaceAll(~/\'/, "")
    def payload = JsonOutput.toJson([
      "username":"Jenkins",
      "icon_url":"https://wiki.jenkins.io/download/attachments/2916393/headshot.png",
      "text": message
    ])
    try {
      sh("curl -X POST -H 'Content-Type: application/json' --data \'${payload}\' ${rocketChatURL}")
    } catch (error) {
      echo "Error posting to Rocket Chat: ${error}"
    }
 }

// Print stack trace of error
@NonCPS
private static String stackTraceAsString(Throwable t) {
    StringWriter sw = new StringWriter();
    t.printStackTrace(new PrintWriter(sw));
    return sw.toString()
}

def _openshift(String name, String project, Closure body) {
  script {
    openshift.withCluster() {
      openshift.withProject(project) {
        echo "Running Stage '${name}'"
        waitUntil {
          boolean isDone=false
          try {
            body()
            isDone=true
            echo "Completed Stage '${name}'"
          } catch (error) {
            echo "${stackTraceAsString(error)}"
            def inputAction = input(
              message: "This step (${name}) has failed. See related messages:",
              ok: 'Confirm',
              parameters: [
                choice(
                  name: 'action',
                  choices: 'Re-run\nIgnore',
                  description: 'What would you like to do?'
                )
              ]
            )
            // todo add a call to cleanup if we 'ignore' failure (change ignore to cleanup)
            if ('Ignore'.equalsIgnoreCase(inputAction)) {
              notifyRocketChat(
                "@all The build ${env.BUILD_DISPLAY_NAME} of eagle-api-pr, seems to be broken.\n ${env.RUN_DISPLAY_URL}\n Error: \n ${error.message}",
              ROCKET_DEPLOY_WEBHOOK
              )
              isDone=true
            }
          }
          return isDone
        }
      }
    }
  }
}

pipeline {
  environment {
    TOOLSPROJECT = "md4m71-tools"
  }
  agent any
  stages {

    stage('Build and Tag Dev'){
      when {
        // todo verify this condidtional
        expression { env.BRANCH_NAME == 'develop' }
      }
      steps {
        script {
          _openshift(env.STAGE_NAME, TOOLSPROJECT) {
            timeout(10) {
              try {
                sh("oc extract secret/rocket-chat-secrets --to=${env.WORKSPACE} --confirm")
                ROCKET_DEPLOY_WEBHOOK = sh(returnStdout: true, script: 'cat rocket-deploy-webhook')
                ROCKET_QA_WEBHOOK = sh(returnStdout: true, script: 'cat rocket-qa-webhook')
              } catch (error) {
                echo "Error retrieving RC tokens"
              }
             

              echo "Building eagle-api develop branch"
              // trigger and wait for s2i build to complete
              def bcObj1 = openshift.selector('bc', "eagle-api")
              def buildSelector1 = bcObj1.narrow("bc").related("builds")
              buildSelector1.untilEach(1) {
                return (it.object().status.phase == "Complete")
              }
              echo "Build done"

              echo ">>> Get Image Hash"
              // Don't tag with BUILD_ID so the pruner can do it's job; it won't delete tagged images.
              // Tag the images for deployment based on the image's hash
              IMAGE_HASH = sh (
                script: """oc get istag eagle-api:latest -o template --template=\"{{.image.dockerImageReference}}\"|awk -F \":\" \'{print \$3}\'""",
                returnStdout: true).trim()
              echo ">> IMAGE_HASH: ${IMAGE_HASH}"
            }

            openshift.tag("${TOOLSPROJECT}/eagle-api:${IMAGE_HASH}", "${TOOLSPROJECT}/eagle-api:dev")
          }
        }
      }
    }

   stage('Tag Dev as Test'){
      when {
        expression { env.BRANCH_NAME == 'test' }
      }
      steps {
        script {
          ROCKET_DEPLOY_WEBHOOK = sh(returnStdout: true, script: 'cat rocket-deploy-webhook')
          ROCKET_QA_WEBHOOK = sh(returnStdout: true, script: 'cat rocket-qa-webhook')
          try {
            echo "Backing up..."
            sh("oc tag esm/eagle-api:test esm/eagle-api:test-backup")
            sleep 5
            echo "Tagging Dev as Test..."
            sh("oc tag esm/eagle-api:dev esm/eagle-api:test")
            sleep 5
            // todo update namespace before switching over
            echo ">>>> Tagging Complete"

            notifyRocketChat(
              "eagle-api dev has been tagged to test",
              ROCKET_DEPLOY_WEBHOOK
            )
            notifyRocketChat(
              "@all eagle-api dev has been tagged as test",
              ROCKET_QA_WEBHOOK
            )
          } catch (error) {
            notifyRocketChat(
              "@all tagging dev as test has failed",
              ROCKET_DEPLOY_WEBHOOK
            )
            currentBuild.result = "FAILURE"
            throw new Exception("Deploy failed")
          }
        }
      }
    }

    stage('Tag Test as Prod'){
      when {
        expression { env.BRANCH_NAME == 'master' }
      }
      steps {
        script {
          ROCKET_DEPLOY_WEBHOOK = sh(returnStdout: true, script: 'cat rocket-deploy-webhook')
          ROCKET_QA_WEBHOOK = sh(returnStdout: true, script: 'cat rocket-qa-webhook')
          try {
            echo "Backing up..."
            sh("oc tag esm/eagle-api:prod esm/eagle-api:prod-backup")
            sleep 5
            echo "Tagging Test as Prod..."
            sh("oc tag esm/eagle-api:test esm/eagle-api:prod")
            sleep 5
            echo ">>>> Tagging Complete"
            notifyRocketChat(
              "eagle-api test has been tagged to Prod",
              ROCKET_DEPLOY_WEBHOOK
            )
            notifyRocketChat(
              "@all eagle-api test has been tagged to prod",
              ROCKET_QA_WEBHOOK
            )
          } catch (error) {
            notifyRocketChat(
              "@all tagging test as prod has failed",
              ROCKET_DEPLOY_WEBHOOK
            )
            currentBuild.result = "FAILURE"
            throw new Exception("Deploy failed")
          }
        }
      }
    }

  }
}
